if(!Image_Manager){window.image_managers=[];var Image_Manager=function(a){this.field=a;this.width=this.field.attr("data-width");this.height=this.field.attr("data-height");this.destroy_url=this.field.attr("data-destroy-url");this.img_width=3230;this.img_height=2153;var b=this;this.editor_scale=this.field.parent().width()>this.width?1:this.field.parent().width()*this.height/this.width/this.height;this.change_mode=function(a){$.inArray(a,["editor","uploader"])==-1&&(a="uploader");if(a=="editor"){this.uploader.hide();this.editor.show()}else{this.uploader.show();this.editor.hide()}};this.size_editor=function(){this.editor_scale=this.manager.parent().width()>this.width?1:this.manager.parent().width()*this.height/this.width/this.height;this.editor.width(this.width*this.editor_scale);$(".image-manager-editor-canvas",this.editor).height(this.height*this.editor_scale);$(".image-manager-editor-information .scale",this.editor).text("at "+Math.round(this.editor_scale*1e3)/10+"% scale")};this.scale_canvas=function(){var a=$(".image-manager-editor-scale .handle",this.editor).position().left,b=$(".image-manager-editor-scale",this.editor).width(),c=a/(b/2);this.canvas_scale=c;var d=this.canvas_scale*this.img_width,e=this.canvas_scale*this.img_height;if(d<this.width){d=this.width;c=this.width/this.img_width;this.canvas_scale=c}if(e<this.height){e=this.height;c=this.height/this.img_height;this.canvas_scale=c}this.set_canvas_scale(c,!0);d*=this.editor_scale;this.editor.find("img").width(d)};this.set_canvas_scale=function(a,b){var c=$(".image-manager-editor-scale",this.editor).width()/2;$(".image-manager-editor-scale .handle",this.editor).css("left",a*c);b||this.scale_canvas()};this.load_image=function(a,b,c,d){this.manager.parent().find("img").remove();this.id=a;this.img_width=c;this.img_height=d;this.manager.append('<input type="hidden" name="'+this.uploader.find("input[type=file]").attr("name")+'" value="'+a+'" />');this.editor.find(".image-manager-editor-canvas").append('<img src="'+b+'" />');var e=this;this.editor.find("img").load(function(){e.set_canvas_scale(1);e.change_mode("editor")});var f=pageStartY=imgStartX=imgStartY=null,g=(new Date).getTime()*Math.floor(Math.random()*11);$(".image-manager-editor-canvas img",this.editor).mousedown(function(a){f=a.pageX;pageStartY=a.pageY;imgStartX=$(this).position().left;imgStartY=$(this).position().top;$(window).bind("mousemove."+g,function(a){var b=a.pageX,c=a.pageY,d=b-f,g=c-pageStartY,h=imgStartX+d,i=imgStartY+g,j=e.canvas_scale*e.img_width*e.editor_scale,k=e.canvas_scale*e.img_height*e.editor_scale,l=e.editor_scale*e.width,m=e.editor_scale*e.height,n=j-l,o=k-m;h<0-n&&(h=0-n);i<0-o&&(i=0-o);h>0&&(h=0);i>0&&(i=0);e.x=h*e.canvas_scale;e.y=i*e.canvas_scale;e.editor.find(".image-manager-editor-canvas img").css("left",h).css("top",i)})});$(window).mouseup(function(){$(window).unbind("mousemove."+g)})};this.save=function(){this.id&&$.ajax({url:"/admin/images/update/"+this.id,type:"POST",data:{image:{x:this.x,y:this.y,width:this.width,height:this.height,scale:this.canvas_scale}},success:function(a){window.console.log(a)},async:!1})};var c=this;this.field.wrap('<div class="image-manager" />');this.manager=this.field.parent();this.field.wrap('<div class="image-manager-uploader" />');this.uploader=$(".image-manager-uploader",this.manager);this.uploader.append('<label class="note">image must be at least '+this.width+"x"+this.height+"</label>");this.uploader.append('<a href="#" class="remove">delete image</a>');this.uploader.find(".remove").click(function(){$.get(b.destroy_url,function(){c.manager.parent().find("img").remove();$(this).remove()});return!1});this.uploader.find("input[type=file]").change(function(){var a=new FormData;a.append("image",c.uploader.find("input[type=file]").get(0).files[0]);$.ajax({url:"/admin/images/upload",type:"POST",success:function(a){c.load_image(a.id,a.url,a.width,a.height)},error:function(){alert("failed")},data:a,cache:!1,contentType:!1,processData:!1})});this.editor=$('<div class="image-manager-editor"><div class="image-manager-editor-canvas"><div class="image-manager-editor-scale"><div class="handle"></div></div></div><div class="image-manager-editor-information"><span class="size">'+this.width+"x"+this.height+'</span><span class="scale"></span></div></div>');var d=handleStartX=null,e=(new Date).getTime()*Math.floor(Math.random()*11);$(".image-manager-editor-scale .handle",this.editor).mousedown(function(a){d=a.pageX;handleStartX=$(this).position().left;$(window).bind("mousemove."+e,function(a){var b=a.pageX,e=b-d,f=$(".image-manager-editor-scale",c.editor).width(),g=handleStartX+e;g>f&&(g=f);g<0&&(g=0);c.editor.find(".handle").css("left",g);c.scale_canvas()})});$(window).mouseup(function(){c.scale_canvas();$(window).unbind("mousemove."+e)});this.editor.hide().appendTo(this.manager);this.editor.parents("form").submit(function(){c.save()});this.size_editor();$(window).bind("resize",function(){c.size_editor()})};$(function(){$("input[type=file].image-manager").each(function(){window.image_managers.push(new Image_Manager($(this)))})})};